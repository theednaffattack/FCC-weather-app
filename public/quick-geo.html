<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.9/css/weather-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.css">
</head>

<body>
    <div class="container">
        <div class="jumbotron">
            <ul class="text-center list-inline">
                <li class="list-inline-item"><h1 id="city-name"></h1></li>
                <li class="list-inline-item"><i id="iconGraphic" class="wi" style="font-size: 3em; color: #924da3;"></i></li>
            </ul>
            <ul class="text-center list-inline">
                <li class="list-inline-item"><span id="weather-temp"></span>&nbsp;
                    <input class="btn btn-warning" type="button" id="1" value="C" style="color: #924da3" onclick="toggle(this);">
                </li>
            </ul>
            <ul class="text-center list-inline">
                <li class="list-inline-item"><span id="weather-temp-min"></span></li>
                <li class="list-inline-item"><span id="weather-temp-max" "></span></li>
			</ul>
			<p class="text-center" id="wind-speed"></p>
			</div>
		</div>
		<script>
			var rawTempGlbl;
			var rawTempMaxGlbl
			var rawTempMinGlbl

			var tempGlbl;

			// check for Geolocation support
			if (navigator.geolocation) {
			  console.log('Geolocation is supported!');
			}
			else {
			  console.log('Geolocation is not supported for this Browser/OS.');
			}

			var cityName = document.getElementById('city-name');
			var weatherTemp = document.getElementById('weather-temp');
			var weatherTempMax = document.getElementById('weather-temp-max');
			var weatherTempMin = document.getElementById('weather-temp-min');;
			var windSpeed = document.getElementById('wind-speed');;

			var weatherIcons;

		    var weatherApiPartial = 'http://api.openweathermap.org/data/2.5/weather?lat=';
		    var geoLookupApiPartial = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=';
		    var geoLookupApiKey = 'AIzaSyAwkBM4FYaENbyryxmCh732C7OJg3JS7h0';
		    var sampleUrl = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=37.7748681,-122.45592429999999&AIzaSyAwkBM4FYaENbyryxmCh732C7OJg3JS7h0';

		    var userLat = '';
		    var userLong = '';
		    var userCity = '';

		    function loadJSON(data) {   
		    	weatherIcons = JSON.parse(data);  
		     }

			function ajaxRequest(method, url, callback) {
			    var xmlhttp = new XMLHttpRequest();

			    xmlhttp.onreadystatechange = function() {
			        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
			            callback(xmlhttp.response);
			        }
			    };

			    xmlhttp.open(method, url, true);
			    xmlhttp.send();
			}


			// Toggles the passed button from OFF to ON and vice-versa.
			function toggle(button, rawTempGlbl) {
			  if (button.value == "F") {
			    convertTemp("F");
			    button.value = "C";
			  } else {
			    convertTemp("C");
			    button.value = "F";
			  }
			}

			// geoLookup function to find the city via Google
			function getCityName(data) {

			    var cityObject = JSON.parse(data);
			    var city = cityObject.results[0].address_components[3].long_name;

			        cityName.innerHTML = city;
			}

			function convertTemp(units) {
				var getUnits = units;
				var newTemp;
				var tempStep;
				// var rawTempMin = tempObject.main.temp_min;
				// var rawTempMax = tempObject.main.temp_max;

				if (getUnits == 'F') {
					//do stuff
					newTemp = Math.round(rawTempGlbl * (9 / 5) - 459.67);
					newTempMax = Math.round(rawTempMaxGlbl * (9 / 5) - 459.67);
					newTempMin = Math.round(rawTempMinGlbl * (9 / 5) - 459.67);

				    weatherTemp.innerHTML = newTemp + '&deg; F';
				    weatherTempMax.innerHTML = newTempMax + '&deg; F';
				    weatherTempMin.innerHTML = newTempMin + '&deg; F';
				} else {
					//do other stuff
					tempStep = Math.round(rawTempGlbl * 100) / 100;
					tempStepMax = Math.round(rawTempMaxGlbl * 100) / 100;
					tempStepMin = Math.round(rawTempMinGlbl * 100) / 100;

					newTemp = Math.round( (tempStep - 273.15) * 100 ) / 100;
					newTempMax = Math.round( (tempStepMax - 273.15) * 100 ) / 100;
					newTempMin = Math.round( (tempStepMin - 273.15) * 100 ) / 100;
					
				    weatherTemp.innerHTML = newTemp + '&deg; C';
				    weatherTempMax.innerHTML = newTempMax + '&deg; C';
				    weatherTempMin.innerHTML = newTempMin + '&deg; C';
				}
			}

			function getLocalWeather(data) {
			    // do stuff
			    var weatherObjectData = JSON.parse(data);

			    // add weather icons
			    var prefix = 'wi-';
			    var code = weatherObjectData.weather[0].id;
			    var icon = weatherIcons[code].icon;
			    var desc = weatherObjectData.weather[0].description;
			    var windSpeedData = weatherObjectData.wind.speed;

			    rawTempGlbl = weatherObjectData.main.temp;
			    rawTempMaxGlbl = weatherObjectData.main.temp_max;
			    rawTempMinGlbl = weatherObjectData.main.temp_min;

			    windSpeed.innerHTML = windSpeedData + ' (mph)';

			    convertTemp('F');  // initialize the weather app with fahrenheit units aka 'F'

			    console.log('rawTempGlbl set inside getLocalWeather: ' + rawTempGlbl + ' degrees Kelvin');

			    // If we are not in the ranges mentioned above, add a day/night prefix.
			    if (!(code > 699 && code < 800) && !(code > 899 && code < 1000)) {
			        icon = 'day-' + icon;
			    }

			    // Finally tack on the prefix.
			    icon = prefix + icon;

			    iconGraphic.classList.add(icon);
				console.log('getLocalWeather finished executing!')

			}

			function getUserLocData(data) {
				// do stuff
				var locData = JSON.parse(data);
				// console.log('locData = ' + JSON.stringify(locData, null, 4));
				console.log('locData.latitude = ' + locData.latitude);
				userLat = locData.latitude;
				console.log('userLat = ' + userLat);
				userLong = locData.longitude;
				cityName.innerHTML = locData.city;
				console.log('locData.city = ' + locData.city);
				console.log('getUserLocData finished executing!');

			    var weatherApiUrl = 'http://api.openweathermap.org/data/2.5/weather?lat=' + userLat + '&lon=' + userLong + '&appid=ea980062829f19db9775cd9d13540204';

			    ajaxRequest('GET', weatherApiUrl, getLocalWeather);
			    console.log('ajax Weather Request completed!')

			}

			window.onload = function() {
			  var startPos;
			  var geoSuccess = function(position) {
			    startPos = position;
			    // var latValue = startPos.coords.latitude;
			    // var longValue = startPos.coords.longitude;
			    // userLat = latValue;
			    // userLong = longValue;

			    var jsonFileLoc = '/app/icon_data/weather-icons.json';
			     

			    var getLocationInfo = 'http://freegeoip.net/json/';

			    // var latMsg = 'Starting Lat: ' + latValue; // Math.round(latValue * 100) / 100; // round to two decimals
			    // var lonMsg = 'Starting Lon: ' + longValue; // Math.round(longValue * 100) / 100;

			    // document.getElementById('startLat').innerHTML = latMsg;
			    // document.getElementById('startLon').innerHTML = lonMsg;
			    console.log('Success! Geolocation data added to DOM.');
			    ajaxRequest('GET', getLocationInfo, getUserLocData);
			    ajaxRequest('GET', jsonFileLoc, loadJSON);
			    // ajaxRequest('GET', geoLookupApiPartial + userLat + ',' + userLong + '&' + geoLookupApiKey, getCityName);
			  };

			  var geoError = function(error) {
			    console.log('Error occurred. Error code: ' + error.code);
			    document.getElementById('error-msg').innerHTML = error.code;
			    // error.code can be:
			    //   0: unknown error
			    //   1: permission denied
			    //   2: position unavailable (error response from location provider)
			    //   3: timed out
			  };
				geoSuccess();
			};
		</script>
	</body>
</html>
